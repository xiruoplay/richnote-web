<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeRich - 个人财富管理 (多币种版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- 引入 Babel 用于浏览器内编译 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#f8f7ff]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- 图标组件 ---
        const IconWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Wallet = (props) => <IconWrapper {...props}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconWrapper>;
        const CreditCard = (props) => <IconWrapper {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconWrapper>;
        const Target = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconWrapper>;
        const DollarSign = (props) => <IconWrapper {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
        const PieChart = (props) => <IconWrapper {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconWrapper>;
        const Coins = (props) => <IconWrapper {...props}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82-.71-.71Z"/></IconWrapper>;
        const BarChart3 = (props) => <IconWrapper {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconWrapper>;
        const Pencil = (props) => <IconWrapper {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
        const CalendarClock = (props) => <IconWrapper {...props}><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h3.5"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h5"/><path d="M21 17a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/><path d="M17 15v2h2"/></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;
        const AlertTriangle = (props) => <IconWrapper {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconWrapper>;

        // --- 配置与常量 ---
        const SUPPORTED_CURRENCIES = [
            { code: 'CNY', symbol: '¥', name: '人民币' },
            { code: 'USD', symbol: '$', name: '美元' },
            { code: 'HKD', symbol: 'HK$', name: '港币' },
            { code: 'JPY', symbol: '¥', name: '日元' },
            { code: 'EUR', symbol: '€', name: '欧元' },
            { code: 'GBP', symbol: '£', name: '英镑' },
        ];

        const DEFAULT_RATES = {
            CNY: 1,
            USD: 0.138,
            HKD: 1.08,
            JPY: 20.8,
            EUR: 0.128,
            GBP: 0.11
        };

        // --- 初始数据 ---
        const INITIAL_ACCOUNTS = [
            { id: 1, name: "招商银行", type: "asset", subtype: "savings", last4: "8888", balance: 85000, currency: "CNY", color: "bg-indigo-500" },
            { id: 2, name: "微信零钱", type: "asset", subtype: "wallet", last4: "Default", balance: 2450, currency: "CNY", color: "bg-green-500" },
            { id: 3, name: "浦发信用卡", type: "debt", subtype: "credit", last4: "1234", balance: -3200, limit: 50000, currency: "CNY", color: "bg-red-500" },
            { id: 4, name: "中信白金", type: "debt", subtype: "credit", last4: "5678", balance: 0, limit: 100000, currency: "CNY", color: "bg-gray-500" },
            { id: 5, name: "易方达蓝筹", type: "investment", subtype: "fund", last4: "0001", balance: 12000, currency: "CNY", color: "bg-blue-500" },
            { id: 6, name: "美股账户", type: "investment", subtype: "stock", last4: "FUTU", balance: 5200, currency: "USD", color: "bg-orange-500" }, 
            { id: 7, name: "积存金", type: "investment", subtype: "gold", last4: "GOLD", balance: 5600, currency: "CNY", color: "bg-yellow-500" },
            { id: 8, name: "3月薪资", type: "future", subtype: "salary", last4: "待入账", balance: 18000, currency: "CNY", color: "bg-cyan-500" },
            { id: 9, name: "项目奖金", type: "future", subtype: "bonus", last4: "待入账", balance: 5000, currency: "CNY", color: "bg-cyan-500" }
        ];

        // --- 模态框组件 ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center p-4 border-b border-purple-100 bg-purple-50/50">
                            <h3 className="font-bold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-purple-100 rounded-full text-gray-500 transition-colors">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主程序 ---
        function BeRichApp() {
            const [accounts, setAccounts] = useState(INITIAL_ACCOUNTS);
            
            // 汇率相关状态
            const [globalCurrency, setGlobalCurrency] = useState('CNY');
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_RATES);
            const [isLoadingRates, setIsLoadingRates] = useState(false);
            const [rateError, setRateError] = useState(false);

            // 模态框状态
            const [isTransModalOpen, setIsTransModalOpen] = useState(false);
            const [isAccountModalOpen, setIsAccountModalOpen] = useState(false);
            const [editingAccountId, setEditingAccountId] = useState(null);
            
            // 删除确认状态
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);

            // 表单状态
            const [newTrans, setNewTrans] = useState({ type: 'expense', amount: '', accountId: '', category: '', tags: '' });
            const [accountForm, setAccountForm] = useState({ name: '', type: 'asset', subtype: 'savings', last4: '', balance: '', currency: 'CNY' });

            // 获取实时汇率
            const fetchRates = async () => {
                setIsLoadingRates(true);
                setRateError(false);
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/CNY');
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    const newRates = {};
                    SUPPORTED_CURRENCIES.forEach(c => {
                        newRates[c.code] = data.rates[c.code] || DEFAULT_RATES[c.code];
                    });
                    setExchangeRates(newRates);
                } catch (error) {
                    console.error("汇率获取失败", error);
                    setRateError(true);
                    setExchangeRates(DEFAULT_RATES);
                } finally {
                    setIsLoadingRates(false);
                }
            };

            useEffect(() => { fetchRates(); }, []);

            // 工具函数
            const formatMoney = (amount, currencyCode) => {
                return new Intl.NumberFormat('zh-CN', {
                    style: 'currency',
                    currency: currencyCode,
                    minimumFractionDigits: 2
                }).format(amount);
            };

            const convertToGlobal = (amount, fromCurrency) => {
                if (fromCurrency === globalCurrency) return amount;
                const rateFrom = exchangeRates[fromCurrency] || 1;
                const rateTo = exchangeRates[globalCurrency] || 1;
                const amountInCNY = amount / rateFrom;
                return amountInCNY * rateTo;
            };

            // 计算逻辑
            const calculateTotal = (type) => {
                return accounts
                    .filter(a => a.type === type)
                    .reduce((sum, a) => sum + convertToGlobal(a.balance, a.currency), 0);
            };

            const totalCash = useMemo(() => calculateTotal('asset'), [accounts, globalCurrency, exchangeRates]);
            const totalInvestments = useMemo(() => calculateTotal('investment'), [accounts, globalCurrency, exchangeRates]);
            const totalDebt = useMemo(() => calculateTotal('debt'), [accounts, globalCurrency, exchangeRates]);
            const totalFuture = useMemo(() => calculateTotal('future'), [accounts, globalCurrency, exchangeRates]);

            const netWorth = totalCash + totalInvestments + totalDebt; 
            const futureTotalAssets = (totalCash + totalInvestments) + totalFuture;

            // 操作处理
            const handleAddTransaction = (e) => {
                e.preventDefault();
                if (!newTrans.amount || !newTrans.accountId) return;
                const amountNum = parseFloat(newTrans.amount);
                const targetAccount = accounts.find(a => a.id === parseInt(newTrans.accountId));
                if (!targetAccount) return;

                const updatedAccounts = accounts.map(acc => {
                    if (acc.id === targetAccount.id) {
                        let newBalance = acc.balance;
                        if (newTrans.type === 'income') newBalance += amountNum;
                        else newBalance -= amountNum;
                        return { ...acc, balance: newBalance };
                    }
                    return acc;
                });
                setAccounts(updatedAccounts);
                setNewTrans({ type: 'expense', amount: '', accountId: '', category: '', tags: '' });
                setIsTransModalOpen(false);
            };

            const handleSaveAccount = (e) => {
                e.preventDefault();
                if(!accountForm.name || accountForm.balance === '') return;

                let color = 'bg-gray-500';
                if (accountForm.type === 'asset') color = 'bg-indigo-500';
                if (accountForm.type === 'debt') color = 'bg-red-500';
                if (accountForm.type === 'future') color = 'bg-cyan-500';
                if (accountForm.type === 'investment') {
                    if (accountForm.subtype === 'gold') color = 'bg-yellow-500';
                    else if (accountForm.subtype === 'stock') color = 'bg-orange-500';
                    else color = 'bg-blue-500';
                }

                const newAccountData = {
                    ...accountForm,
                    last4: accountForm.last4 || (accountForm.type === 'future' ? '待入账' : '0000'),
                    balance: parseFloat(accountForm.balance),
                    color
                };

                if (editingAccountId) {
                    setAccounts(accounts.map(acc => acc.id === editingAccountId ? { ...acc, ...newAccountData } : acc));
                } else {
                    setAccounts([...accounts, { id: Date.now(), ...newAccountData }]);
                }
                closeAccountModal();
            };

            // 触发删除（只打开确认框）
            const promptDelete = (id) => {
                setDeleteConfirmId(id);
            };

            // 执行删除
            const executeDelete = () => {
                if (deleteConfirmId) {
                    setAccounts(accounts.filter(a => a.id !== deleteConfirmId));
                    setDeleteConfirmId(null);
                    // 如果正在编辑的是被删除的账户，关闭编辑框
                    if (editingAccountId === deleteConfirmId) {
                        closeAccountModal();
                    }
                }
            };

            const openAddAccountModal = (type = 'asset') => {
                setEditingAccountId(null);
                setAccountForm({ name: '', type: type, subtype: type === 'investment' ? 'fund' : 'savings', last4: type === 'future' ? '待入账' : '', balance: '', currency: globalCurrency });
                setIsAccountModalOpen(true);
            };

            const openEditAccountModal = (account) => {
                setEditingAccountId(account.id);
                setAccountForm({ ...account });
                setIsAccountModalOpen(true);
            };

            const closeAccountModal = () => {
                setIsAccountModalOpen(false);
                setEditingAccountId(null);
                setAccountForm({ name: '', type: 'asset', subtype: 'savings', last4: '', balance: '', currency: 'CNY' });
            };

            const AccountItem = ({ acc }) => {
                let IconComponent = Wallet;
                if (acc.type === 'debt') IconComponent = CreditCard;
                if (acc.type === 'future') IconComponent = CalendarClock;
                if (acc.type === 'investment') {
                    if (acc.subtype === 'stock') IconComponent = BarChart3;
                    else if (acc.subtype === 'gold') IconComponent = Coins;
                    else IconComponent = PieChart;
                }

                let borderColor = 'border-indigo-300';
                if (acc.type === 'debt') borderColor = 'border-red-400';
                if (acc.type === 'investment') borderColor = 'border-orange-300';
                if (acc.type === 'future') borderColor = 'border-cyan-300';

                return (
                    <div className={`group flex justify-between items-center p-4 rounded-xl border-l-4 transition-all hover:shadow-md mb-3 bg-white border-transparent ${borderColor}`}>
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full ${acc.color} flex items-center justify-center text-white shadow-md shrink-0`}>
                                <IconComponent size={18} />
                            </div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <p className="font-bold text-gray-800">{acc.name}</p>
                                    <span className="text-[10px] bg-gray-100 text-gray-500 px-1.5 rounded font-mono font-bold">{acc.currency}</span>
                                </div>
                                <p className="text-xs text-gray-400 font-mono">{acc.last4 === '待入账' ? '待入账' : `**** ${acc.last4}`}</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <div className="text-right">
                                <span className={`font-bold text-lg ${acc.balance < 0 ? 'text-red-600' : 'text-gray-800'}`}>
                                    {formatMoney(acc.balance, acc.currency)}
                                </span>
                                {acc.currency !== globalCurrency && (
                                    <p className="text-[10px] text-gray-400">
                                        ≈ {formatMoney(convertToGlobal(acc.balance, acc.currency), globalCurrency)}
                                    </p>
                                )}
                            </div>
                            <div className="flex flex-col gap-1 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => openEditAccountModal(acc)} className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition"><Pencil size={14} /></button>
                                <button onClick={() => promptDelete(acc.id)} className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-md transition"><Trash2 size={14} /></button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-[#f8f7ff] text-gray-700 font-sans p-4 md:p-8">
                    {/* Header */}
                    <div className="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-3 self-start md:self-auto">
                            <div className="bg-purple-600 text-white p-2 rounded-lg shadow-lg shadow-purple-200">
                                <Wallet size={24} />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-purple-900 tracking-tight">BeRich</h1>
                                <p className="text-xs text-purple-400 font-medium">Wealth Manager</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2 self-end md:self-auto">
                            <button onClick={fetchRates} className={`p-2 rounded-full text-purple-500 hover:bg-purple-100 transition ${isLoadingRates ? 'spin' : ''}`} title="更新汇率"><RefreshCw size={18} /></button>
                            <div className="relative">
                                <select value={globalCurrency} onChange={(e) => setGlobalCurrency(e.target.value)} className="appearance-none bg-white pl-4 pr-10 py-1.5 rounded-full text-sm font-bold text-purple-700 shadow-sm border border-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer hover:bg-purple-50 transition">
                                    {SUPPORTED_CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code} {c.symbol}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-purple-500"><svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div>
                            </div>
                            <div className="bg-white px-4 py-1.5 rounded-full text-sm font-medium text-purple-600 shadow-sm border border-purple-100 whitespace-nowrap">{new Date().getFullYear()}年{new Date().getMonth() + 1}月</div>
                        </div>
                    </div>

                    {/* Dashboard */}
                    <div className="max-w-7xl mx-auto mb-8">
                        <div className="relative overflow-hidden bg-gradient-to-br from-[#8b5cf6] to-[#6d28d9] rounded-3xl p-6 md:p-8 text-white shadow-xl shadow-purple-200">
                            <div className="absolute top-0 right-0 p-8 opacity-10"><DollarSign size={120} /></div>
                            <div className="relative z-10">
                                <div className="flex items-center gap-2 mb-1">
                                    <p className="text-purple-100 text-sm font-medium">当前净资产 (Net Worth)</p>
                                    {rateError && <span className="text-[10px] bg-red-500/30 px-1.5 rounded text-red-100">使用离线汇率</span>}
                                </div>
                                <h2 className="text-4xl md:text-5xl font-bold tracking-tight mb-6">{formatMoney(netWorth, globalCurrency)}</h2>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-sm">
                                    <div className="bg-white/10 backdrop-blur-md rounded-xl p-3"><span className="opacity-70 block mb-1">当前总资产 (Asset)</span><span className="font-semibold text-lg flex items-center gap-1 text-white">{formatMoney(totalCash + totalInvestments, globalCurrency)}</span></div>
                                    <div className="bg-white/10 backdrop-blur-md rounded-xl p-3"><span className="opacity-70 block mb-1">当前总负债 (Debt)</span><span className="font-semibold text-lg flex items-center gap-1 text-red-300">{formatMoney(totalDebt, globalCurrency)}</span></div>
                                    <div className="bg-white/10 backdrop-blur-md rounded-xl p-3 border border-cyan-400/30 bg-cyan-500/10"><span className="opacity-90 block mb-1 text-cyan-100">未来总资产 (Future Total)</span><span className="font-semibold text-lg flex items-center gap-1 text-cyan-200"><Target size={16} /> {formatMoney(futureTotalAssets, globalCurrency)}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Grid */}
                    <div className="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mb-24">
                        {/* 1. Cash */}
                        <div className="bg-purple-50/50 rounded-2xl p-4 md:p-6 border border-purple-100">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2"><div className="bg-indigo-100 p-1.5 rounded-md text-indigo-600"><Wallet size={18} /></div><h3 className="font-bold text-gray-800 text-lg">现金账户</h3></div>
                                <button onClick={() => openAddAccountModal('asset')} className="text-xs bg-white border border-indigo-100 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-50 transition">+ 添加</button>
                            </div>
                            <div className="flex justify-between text-sm text-gray-500 mb-4 px-1"><span>折算总计 ({globalCurrency})</span><span className="font-bold text-indigo-600">{formatMoney(totalCash, globalCurrency)}</span></div>
                            <div>{accounts.filter(a => a.type === 'asset').map(acc => <AccountItem key={acc.id} acc={acc} />)}</div>
                        </div>

                        {/* 2. Investment */}
                        <div className="bg-orange-50/50 rounded-2xl p-4 md:p-6 border border-orange-100">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2"><div className="bg-orange-100 p-1.5 rounded-md text-orange-600"><TrendingUp size={18} /></div><h3 className="font-bold text-gray-800 text-lg">理财投资</h3></div>
                                <button onClick={() => openAddAccountModal('investment')} className="text-xs bg-white border border-orange-100 text-orange-600 px-2 py-1 rounded hover:bg-orange-50 transition">+ 添加</button>
                            </div>
                            <div className="flex justify-between text-sm text-gray-500 mb-4 px-1"><span>折算总计 ({globalCurrency})</span><span className="font-bold text-orange-600">{formatMoney(totalInvestments, globalCurrency)}</span></div>
                            <div>
                                {accounts.filter(a => a.type === 'investment').map(acc => <AccountItem key={acc.id} acc={acc} />)}
                                {accounts.filter(a => a.type === 'investment').length === 0 && <div className="text-center py-8 text-gray-400 border-2 border-dashed border-orange-100 rounded-xl"><p className="text-sm">暂无理财</p></div>}
                            </div>
                        </div>

                        {/* 3. Future */}
                         <div className="bg-cyan-50/50 rounded-2xl p-4 md:p-6 border border-cyan-100">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2"><div className="bg-cyan-100 p-1.5 rounded-md text-cyan-600"><CalendarClock size={18} /></div><h3 className="font-bold text-gray-800 text-lg">未来计划资产</h3></div>
                                <button onClick={() => openAddAccountModal('future')} className="text-xs bg-white border border-cyan-100 text-cyan-600 px-2 py-1 rounded hover:bg-cyan-50 transition">+ 添加</button>
                            </div>
                            <div className="flex justify-between text-sm text-gray-500 mb-4 px-1"><span>折算总计 ({globalCurrency})</span><span className="font-bold text-cyan-600">{formatMoney(totalFuture, globalCurrency)}</span></div>
                            <div>
                                {accounts.filter(a => a.type === 'future').map(acc => <AccountItem key={acc.id} acc={acc} />)}
                                {accounts.filter(a => a.type === 'future').length === 0 && <div className="text-center py-8 text-gray-400 border-2 border-dashed border-cyan-100 rounded-xl"><p className="text-sm">暂无计划收入</p></div>}
                            </div>
                        </div>

                        {/* 4. Debt */}
                        <div className="bg-red-50/50 rounded-2xl p-4 md:p-6 border border-red-100">
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2"><div className="bg-red-100 p-1.5 rounded-md text-red-600"><CreditCard size={18} /></div><h3 className="font-bold text-gray-800 text-lg">信用卡/负债</h3></div>
                                <button onClick={() => openAddAccountModal('debt')} className="text-xs bg-white border border-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-50 transition">+ 添加</button>
                            </div>
                            <div className="flex justify-between text-sm text-gray-500 mb-4 px-1"><span>折算总计 ({globalCurrency})</span><span className="font-bold text-red-600">{formatMoney(totalDebt, globalCurrency)}</span></div>
                            <div>{accounts.filter(a => a.type === 'debt').map(acc => <AccountItem key={acc.id} acc={acc} />)}</div>
                        </div>
                    </div>

                    {/* FAB Button */}
                    <button onClick={() => setIsTransModalOpen(true)} className="fixed bottom-8 right-8 bg-purple-600 hover:bg-purple-500 text-white w-14 h-14 rounded-full shadow-lg shadow-purple-300 flex items-center justify-center text-xl transition transform hover:scale-110 active:scale-95 z-40"><Plus size={28} /></button>

                    {/* 记账 Modal */}
                    <Modal isOpen={isTransModalOpen} onClose={() => setIsTransModalOpen(false)} title="记一笔 (New Transaction)">
                        <form onSubmit={handleAddTransaction} className="flex flex-col gap-4">
                            <div className="flex bg-gray-100 p-1 rounded-lg mb-2">
                                <button type="button" className={`flex-1 py-2 rounded-md text-sm font-medium transition ${newTrans.type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-500'}`} onClick={() => setNewTrans({...newTrans, type: 'expense'})}>支出</button>
                                <button type="button" className={`flex-1 py-2 rounded-md text-sm font-medium transition ${newTrans.type === 'income' ? 'bg-white text-green-500 shadow-sm' : 'text-gray-500'}`} onClick={() => setNewTrans({...newTrans, type: 'income'})}>收入</button>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">金额 (使用账户原币种)</label>
                                <div className="relative mt-1"><span className="absolute left-3 top-2.5 text-gray-400">#</span><input type="number" step="0.01" required className="w-full pl-8 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg font-bold text-gray-800" placeholder="0.00" value={newTrans.amount} onChange={e => setNewTrans({...newTrans, amount: e.target.value})}/></div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">选择账户</label>
                                <select required className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" value={newTrans.accountId} onChange={e => setNewTrans({...newTrans, accountId: e.target.value})}>
                                    <option value="">请选择...</option>
                                    <optgroup label="现金账户">{accounts.filter(a => a.type === 'asset').map(a => <option key={a.id} value={a.id}>{a.name} ({formatMoney(a.balance, a.currency)})</option>)}</optgroup>
                                    <optgroup label="理财账户">{accounts.filter(a => a.type === 'investment').map(a => <option key={a.id} value={a.id}>{a.name} ({formatMoney(a.balance, a.currency)})</option>)}</optgroup>
                                    <optgroup label="信用卡">{accounts.filter(a => a.type === 'debt').map(a => <option key={a.id} value={a.id}>{a.name} ({formatMoney(a.balance, a.currency)})</option>)}</optgroup>
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500 uppercase">类别</label><input type="text" required className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="如: 餐饮" value={newTrans.category} onChange={e => setNewTrans({...newTrans, category: e.target.value})}/></div>
                                <div><label className="text-xs font-bold text-gray-500 uppercase">标签</label><input type="text" className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="#午餐" value={newTrans.tags} onChange={e => setNewTrans({...newTrans, tags: e.target.value})}/></div>
                            </div>
                            <button type="submit" className="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 transition">确认记账</button>
                        </form>
                    </Modal>

                    {/* 账户 Modal */}
                    <Modal isOpen={isAccountModalOpen} onClose={closeAccountModal} title={editingAccountId ? "编辑账户" : "添加新账户"}>
                        <form onSubmit={handleSaveAccount} className="flex flex-col gap-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">账户类型</label>
                                <select className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" value={accountForm.type} onChange={e => setAccountForm({...accountForm, type: e.target.value})}>
                                    <option value="asset">储蓄/现金</option>
                                    <option value="investment">理财投资</option>
                                    <option value="future">未来计划资产</option>
                                    <option value="debt">信用卡/借贷</option>
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">结算货币</label>
                                <div className="flex flex-wrap gap-2 mt-1">
                                    {SUPPORTED_CURRENCIES.map(c => (
                                        <button key={c.code} type="button" onClick={() => setAccountForm({...accountForm, currency: c.code})} className={`px-3 py-1.5 text-xs rounded border transition font-bold ${accountForm.currency === c.code ? 'bg-purple-100 border-purple-500 text-purple-700' : 'bg-white border-gray-200 text-gray-500'}`}>{c.code}</button>
                                    ))}
                                </div>
                            </div>
                            {accountForm.type === 'investment' && (
                                <div className="animate-in fade-in slide-in-from-top-2 duration-200">
                                    <label className="text-xs font-bold text-orange-500 uppercase">投资类别</label>
                                    <div className="flex gap-2 mt-1">
                                        {['fund', 'stock', 'gold', 'other'].map(sub => (
                                            <button key={sub} type="button" onClick={() => setAccountForm({...accountForm, subtype: sub})} className={`flex-1 py-1.5 text-xs rounded border transition ${accountForm.subtype === sub ? 'bg-orange-100 border-orange-500 text-orange-700 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>{sub === 'fund' && '基金'}{sub === 'stock' && '股票'}{sub === 'gold' && '黄金'}{sub === 'other' && '其他'}</button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div><label className="text-xs font-bold text-gray-500 uppercase">名称</label><input type="text" required className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="名称" value={accountForm.name} onChange={e => setAccountForm({...accountForm, name: e.target.value})}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-gray-500 uppercase">{accountForm.type === 'future' ? '状态/备注' : '卡号/尾号'}</label><input type="text" className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder={accountForm.type === 'future' ? '待入账' : '8888'} value={accountForm.last4} onChange={e => setAccountForm({...accountForm, last4: e.target.value})}/></div>
                                <div><label className="text-xs font-bold text-gray-500 uppercase">{accountForm.type === 'debt' ? '当前负债 (负数)' : '金额'}</label><input type="number" step="0.01" required className="w-full mt-1 px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="0.00" value={accountForm.balance} onChange={e => setAccountForm({...accountForm, balance: e.target.value})}/></div>
                            </div>
                            <button type="submit" className="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-purple-200 transition">{editingAccountId ? "保存修改" : "确认添加"}</button>
                            {editingAccountId && <button type="button" onClick={() => promptDelete(editingAccountId)} className="w-full bg-red-50 text-red-500 py-2 rounded-xl text-sm font-medium hover:bg-red-100 transition">删除此项目</button>}
                        </form>
                    </Modal>

                    {/* 删除确认 Modal (修复: 使用自定义弹窗代替 window.confirm) */}
                    <Modal isOpen={!!deleteConfirmId} onClose={() => setDeleteConfirmId(null)} title="确认删除">
                        <div className="flex flex-col items-center text-center p-4">
                            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-500 mb-3">
                                <AlertTriangle size={24} />
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 mb-2">确定要删除吗？</h3>
                            <p className="text-gray-500 text-sm mb-6">此操作将永久删除该账户及其相关记录，无法撤销。</p>
                            <div className="flex gap-3 w-full">
                                <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition">取消</button>
                                <button onClick={executeDelete} className="flex-1 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium shadow-lg shadow-red-200 transition">确认删除</button>
                            </div>
                        </div>
                    </Modal>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BeRichApp />);
    </script>
</body>
</html>